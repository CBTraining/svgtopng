<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageTools v1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    
    <!-- FIX: Temporarily disable transitions on load to prevent flicker -->
    <style id="initial-transition-disabler">
        * { transition: none !important; }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'accent': '#34A853',
                        'accent-hover': '#2c8d48',
                        // RENAMED variables to use underscores for safer parsing
                        'text-primary': 'var(--text_primary_dark)',
                        'text-secondary': 'var(--text_secondary_subtle)',
                        'bg-page': 'var(--bg_page)',
                        'bg-sidebar': 'var(--bg_sidebar)',
                        'bg-card': 'var(--bg_card)',
                        'border-default': 'var(--border_default)',
                        'bg-input': 'var(--bg_input)',
                        'hover-item': 'var(--hover_item)',
                    },
                    fontFamily: {
                        sans: ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* --- CENTRALIZED COLOR VARIABLES --- */
        :root {
            /* Renamed variables */
            --text_primary_dark: #1b1c1f;
            --text_secondary_subtle: #18181a;
            --bg_page: #f8f9fa; 
            --bg_sidebar: #ffffff;
            --bg_card: #ffffff;
            --border_default: #e5e7eb;
            --bg_input: #f9fafb;
            --hover_item: #f0fdf4;
        }

        html.dark {
            /* Renamed variables */
            --text_primary_dark: #f1f5f9;
            --text_secondary_subtle: #94a3b8;
            --bg_page: #0f172a;
            --bg_sidebar: #1e293b;
            --bg_card: #1e293b;
            --border_default: #334155;
            --bg_input: #0f172a;
            --hover_item: #334155;
        }

        body {
            font-family: 'Poppins', sans-serif; 
            background-color: var(--bg_page);
            color: var(--text_primary_dark);
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden; 
        }
        
        .sidebar {
            background-color: var(--bg_sidebar);
            border-right: 1px solid var(--border_default);
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .nav-item {
            color: var(--text_primary_dark); 
            transition: all 0.2s;
            font-weight: 500; 
        }
        /* Hover state for inactive items */
        .nav-item:hover:not(.active) {
            background-color: var(--hover_item);
            color: #34A853;
        }
        /* Active state (Reference style: only color change) */
        .nav-item.active {
            color: #34A853; /* Green text */
            background-color: var(--hover_item); /* Subtle background on active */
            font-weight: 600; /* Semi-bold weight for active */
        }

        .tool-card {
            background-color: var(--bg_card);
            border: 1px solid var(--border_default);
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        html.dark .custom-scroll::-webkit-scrollbar-thumb { background-color: #475569; }

        #svg-display, .image-preview-box {
            min-height: 240px; 
            border: 2px dashed var(--border_default);
            display: flex; align-items: center; justify-content: center;
            background-color: var(--bg_input);
            overflow: hidden;
            border-radius: 0.5rem;
            position: relative;
        }
        
        #svg-display > svg, .image-preview-box img {
            max-width: 100%; max-height: 100%; object-fit: contain;
        }
        
        input[type="text"], input[type="number"], textarea {
            background-color: var(--bg_input);
            border: 1px solid var(--border_default);
            color: var(--text_primary_dark);
            border-radius: 0.5rem;
        }
        input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
            outline: none;
            border-color: #34A853;
            ring: 2px solid #34A853;
        }

        input[type=range]::-webkit-slider-runnable-track { background: #e5e7eb; border-radius: 4px; height: 6px; }
        html.dark input[type=range]::-webkit-slider-runnable-track { background: #334155; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 18px; width: 18px; 
            border-radius: 50%; background: #34A853; margin-top: -6px; cursor: pointer;
            box-shadow: 0 0 0 2px var(--bg_card);
        }
        
        /* Ensure these custom classes use the new variable names */
        .text-primary { color: var(--text_primary_dark) !important; }
        .text-secondary { color: var(--text_secondary_subtle) !important; }
        
    </style>
</head>
<body class="flex h-screen w-full text-primary">

    <!-- SIDEBAR -->
    <aside class="sidebar w-72 flex-shrink-0 flex flex-col hidden md:flex z-20 h-full">
        <!-- Logo Area -->
        <div class="px-6 pt-8 pb-6 flex items-center gap-3">
            <div class="w-10 h-10 bg-accent rounded-lg flex items-center justify-center text-white text-xl shadow-md flex-shrink-0">
                <i class="fas fa-layer-group"></i>
            </div>
            <div class="flex flex-col justify-center">
                <h1 class="text-xl font-bold leading-none text-primary">ImageTools</h1>
                <p class="text-xs text-secondary font-medium mt-0.5">Toolkit v1</p>
            </div>
        </div>

        <!-- Big Green Action Button -->
        <div class="px-6 mb-8">
            <button id="clipboard-download-button" class="w-full bg-accent hover:bg-accent-hover text-white py-3 px-4 rounded-xl shadow-md transition-all flex items-center justify-center gap-2 font-bold text-sm group transform active:scale-95">
                <i class="fas fa-clipboard text-lg"></i>
                <span>Clipboard to PNG</span>
            </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto px-6 space-y-1 custom-scroll">
            <div class="text-xs font-bold text-secondary uppercase tracking-wider mb-3 px-2">TOOLS</div>
            
            <button onclick="switchTab('resizer')" id="nav-resizer" class="nav-item w-full flex items-center gap-4 px-2 py-3 rounded-lg text-left font-medium group">
                <i class="fas fa-arrows-alt-h w-5 text-center text-lg transition-colors"></i>
                <span class="text-[15px]">Resizer & Converter</span>
            </button>

            <button onclick="switchTab('compressor')" id="nav-compressor" class="nav-item w-full flex items-center gap-4 px-2 py-3 rounded-lg text-left font-medium group">
                <i class="fas fa-compress-arrows-alt w-5 text-center text-lg transition-colors"></i>
                <span class="text-[15px]">Image Compressor</span>
            </button>

            <button onclick="switchTab('scaler')" id="nav-scaler" class="nav-item w-full flex items-center gap-4 px-2 py-3 rounded-lg text-left font-medium group">
                <i class="fas fa-expand w-5 text-center text-lg transition-colors"></i>
                <span class="text-[15px]">SVG Icon Scaler</span>
            </button>
            
            <button onclick="switchTab('formatter')" id="nav-formatter" class="nav-item w-full flex items-center gap-4 px-2 py-3 rounded-lg text-left font-medium group">
                <i class="fas fa-code w-5 text-center text-lg transition-colors"></i>
                <span class="text-[15px]">HTML Formatter</span>
            </button>
        </nav>

        <!-- Footer / Theme Toggle -->
        <div class="p-6 mt-auto">
            <button id="theme-toggle" class="w-full flex items-center justify-between px-4 py-2.5 border border-default rounded-lg hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors text-secondary">
                <div class="flex items-center gap-2">
                    <i class="fas fa-moon" id="theme-icon"></i>
                    <span class="text-sm font-medium">Dark Mode</span>
                </div>
                <div class="w-9 h-5 bg-gray-200 dark:bg-slate-600 rounded-full relative">
                    <div class="absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform duration-300 dark:translate-x-4 shadow-sm"></div>
                </div>
            </button>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative bg-page">
        
        <!-- Mobile Header -->
        <header class="md:hidden bg-card border-b border-default p-4 flex justify-between items-center z-30 sticky top-0 shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-accent rounded flex items-center justify-center text-white shadow-sm">
                    <i class="fas fa-layer-group text-sm"></i>
                </div>
                <span class="font-bold text-primary text-lg">ImageTools</span>
            </div>
            <button id="mobile-menu-btn" class="text-primary p-2 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </header>

        <!-- Tool Content Container -->
        <div class="flex-1 overflow-y-auto p-4 md:p-12 custom-scroll" id="main-scroll-area">
            <div class="max-w-6xl mx-auto">
                
                <!-- TOOL 1: RESIZER -->
                <div id="tool-resizer" class="tool-section hidden">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-primary mb-2">SVG Resizer & Converter</h2>
                        <p class="text-secondary text-lg">Upload an SVG file, precisely adjust its dimensions or crop it, and download high-quality PNGs.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        <!-- Left Column: Upload & Preview -->
                        <div class="lg:col-span-5 space-y-6">
                            <div class="tool-card p-6">
                                <label class="block text-sm font-bold text-primary mb-3 uppercase tracking-wide">Source File</label>
                                <div id="svg-display" class="mb-4 bg-dots">
                                    <div class="text-center p-6">
                                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-300 mb-3"></i>
                                        <p class="text-sm text-secondary">No file selected</p>
                                    </div>
                                </div>
                                <label for="svg-upload" class="flex items-center justify-center w-full px-4 py-3 bg-white border-2 border-dashed border-gray-300 hover:border-accent hover:text-accent text-gray-500 rounded-xl cursor-pointer transition-all font-medium group">
                                    <i class="fas fa-upload mr-2 group-hover:scale-110 transition-transform"></i> Upload SVG
                                    <input type="file" id="svg-upload" accept=".svg,image/svg+xml" class="hidden"/>
                                </label>
                            </div>
                        </div>

                        <!-- Right Column: Controls -->
                        <div class="lg:col-span-7 space-y-6">
                            <div class="tool-card p-6" id="processing-area">
                                <div class="flex items-center justify-between mb-6 pb-4 border-b border-default">
                                    <h3 class="text-lg font-bold text-primary flex items-center gap-2">
                                        <i class="fas fa-sliders-h text-accent"></i> Parameters
                                    </h3>
                                    <div class="flex items-center gap-2 bg-gray-50 dark:bg-slate-800 px-3 py-1.5 rounded-full">
                                        <input type="checkbox" id="lock-aspect" class="h-4 w-4 text-accent rounded border-gray-300 focus:ring-accent cursor-pointer" checked>
                                        <label for="lock-aspect" class="text-xs font-semibold text-primary cursor-pointer uppercase tracking-wide">Lock Ratio</label>
                                    </div>
                                </div>

                                <!-- Dimensions -->
                                <div class="space-y-6 mb-8">
                                    <div>
                                        <div class="flex justify-between mb-2">
                                            <label class="text-sm font-bold text-primary">Width</label>
                                            <span class="text-xs font-mono text-secondary bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded">px</span>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <input type="range" id="width-range" min="1" max="6000" value="500" class="flex-1 accent-green-500">
                                            <input type="number" id="width-input" class="w-24 p-2 text-center text-sm font-semibold border-default rounded-lg shadow-sm" value="500">
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex justify-between mb-2">
                                            <label class="text-sm font-bold text-primary">Height</label>
                                            <span class="text-xs font-mono text-secondary bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded">px</span>
                                        </div>
                                        <div class="flex items-center gap-4">
                                            <input type="range" id="height-range" min="1" max="6000" value="500" class="flex-1 accent-green-500">
                                            <input type="number" id="height-input" class="w-24 p-2 text-center text-sm font-semibold border-default rounded-lg shadow-sm" value="500">
                                        </div>
                                    </div>
                                </div>

                                <!-- Cropping -->
                                <div class="border-t border-default pt-6 mb-6">
                                    <h4 class="text-xs font-bold text-secondary uppercase tracking-wider mb-4">Cropping</h4>
                                    <div class="grid grid-cols-2 gap-x-6 gap-y-4">
                                        <div class="space-y-1">
                                            <label class="text-xs font-medium text-secondary">Left</label>
                                            <div class="flex gap-2 items-center"><input type="range" id="crop-left-range" class="flex-1 h-1"><input type="number" id="crop-left-input" class="w-16 text-xs p-1.5 text-center border-default rounded"></div>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-xs font-medium text-secondary">Right</label>
                                            <div class="flex gap-2 items-center"><input type="range" id="crop-right-range" class="flex-1 h-1"><input type="number" id="crop-right-input" class="w-16 text-xs p-1.5 text-center border-default rounded"></div>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-xs font-medium text-secondary">Top</label>
                                            <div class="flex gap-2 items-center"><input type="range" id="crop-top-range" class="flex-1 h-1"><input type="number" id="crop-top-input" class="w-16 text-xs p-1.5 text-center border-default rounded"></div>
                                        </div>
                                        <div class="space-y-1">
                                            <label class="text-xs font-medium text-secondary">Bottom</label>
                                            <div class="flex gap-2 items-center"><input type="range" id="crop-bottom-range" class="flex-1 h-1"><input type="number" id="crop-bottom-input" class="w-16 text-xs p-1.5 text-center border-default rounded"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Rounding -->
                                <div class="border-t border-default pt-6 mb-8">
                                    <div class="flex justify-between mb-2">
                                        <label class="text-sm font-bold text-primary">Corner Rounding</label>
                                        <span class="text-xs font-mono text-secondary bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded">px</span>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <input type="range" id="rounded-range" min="0" max="500" value="0" class="flex-1 accent-green-500">
                                        <input type="number" id="rounded-input" class="w-24 p-2 text-center text-sm font-semibold border-default rounded-lg shadow-sm" value="0">
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="grid grid-cols-2 gap-4 pt-4 border-t border-default">
                                    <button id="copy-button" disabled class="py-3 px-4 rounded-xl font-bold text-sm bg-white border border-default text-secondary hover:bg-gray-50 hover:text-primary dark:bg-slate-800 dark:hover:bg-slate-700 transition-all disabled:opacity-50 shadow-sm">
                                        <i class="far fa-copy mr-2"></i> Copy Image
                                    </button>
                                    <button id="download-button" disabled class="py-3 px-4 rounded-xl font-bold text-sm bg-accent text-white hover:bg-accent-hover transition-all disabled:opacity-50 shadow-md transform active:scale-95">
                                        <i class="fas fa-download mr-2"></i> Download PNG
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TOOL 2: COMPRESSOR -->
                <div id="tool-compressor" class="tool-section hidden">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-primary mb-2">Image Compressor</h2>
                        <p class="text-secondary text-lg">Optimize JPG and PNG files to reduce file size without losing visible quality.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Original -->
                        <div class="tool-card p-6">
                             <h3 class="text-lg font-bold text-primary mb-4 flex items-center gap-2"><i class="far fa-image text-secondary"></i> Original</h3>
                             <div id="original-image-display" class="image-preview-box mb-6 bg-dots">
                                 <p class="text-sm text-secondary">Select an image</p>
                             </div>
                             <label for="image-upload" class="flex items-center justify-center w-full px-4 py-4 bg-gray-50 hover:bg-gray-100 border-2 border-dashed border-gray-300 dark:bg-slate-800/50 dark:hover:bg-slate-800 text-primary rounded-xl cursor-pointer transition-all font-medium group">
                                <i class="fas fa-image mr-2 text-secondary group-hover:text-accent transition-colors"></i> Select Image
                                <input type="file" id="image-upload" accept="image/jpeg,image/png" class="hidden"/>
                            </label>
                        </div>

                        <!-- Compressed -->
                        <div class="tool-card p-6">
                            <h3 class="text-lg font-bold text-primary mb-4 flex items-center gap-2"><i class="fas fa-bolt text-accent"></i> Compressed Result</h3>
                             <div id="compressed-image-display" class="image-preview-box mb-6 relative bg-dots">
                                 <p class="text-sm text-secondary">Result preview</p>
                             </div>
                             
                             <div id="compressor-processing-area" class="opacity-50 pointer-events-none space-y-6">
                                 <div>
                                     <div class="flex justify-between mb-2">
                                        <label class="text-sm font-bold text-primary">Quality Level</label>
                                        <span id="quality-value" class="text-sm font-mono bg-green-100 text-green-700 px-2 py-0.5 rounded font-bold">75%</span>
                                     </div>
                                     <input type="range" id="quality-slider" min="0" max="100" value="75" class="w-full accent-green-500">
                                 </div>
                                 
                                 <div id="file-size-display" class="bg-blue-50 dark:bg-slate-800/50 border border-blue-100 dark:border-slate-700 p-4 rounded-xl text-center text-sm text-primary">
                                     Waiting for image...
                                 </div>

                                 <button id="download-compressed-button" disabled class="w-full py-3 bg-accent hover:bg-accent-hover text-white font-bold rounded-xl shadow-lg transition-all disabled:opacity-50 transform active:scale-95">
                                     Download Compressed
                                 </button>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- TOOL 3: SCALER -->
                <div id="tool-scaler" class="tool-section hidden">
                    <div class="mb-8">
                        <h2 class="text-3xl font-bold text-primary mb-2">SVG Icon Scaler</h2>
                        <p class="text-secondary text-lg">Batch generate pixel-perfect PNGs from SVG code at multiple scales (2x, 4x, 8x, 16x).</p>
                    </div>

                    <div class="tool-card p-6 mb-8">
                        <label class="block text-sm font-bold text-primary mb-3 uppercase tracking-wide">Input SVG Code</label>
                        <textarea id="svgInputScaler" rows="6" class="w-full p-4 font-mono text-xs border-default bg-input rounded-xl resize-y focus:ring-2 focus:ring-accent focus:border-accent shadow-inner" placeholder="<svg ...>"></textarea>
                        
                        <div class="flex gap-4 mt-6">
                            <label for="svgFileUploaderScaler" class="px-5 py-2.5 bg-white border border-default hover:bg-gray-50 dark:bg-slate-800 dark:hover:bg-slate-700 text-primary font-bold rounded-lg cursor-pointer transition-colors shadow-sm">
                                <i class="fas fa-file-code mr-2 text-secondary"></i> Load File
                                <input type="file" id="svgFileUploaderScaler" accept=".svg" class="hidden">
                            </label>
                            <button id="convertButtonScaler" class="px-8 py-2.5 bg-primary hover:bg-gray-800 dark:bg-slate-600 dark:hover:bg-slate-500 text-white font-bold rounded-lg shadow-md transition-colors ml-auto">
                                Generate All Sizes
                            </button>
                        </div>
                    </div>

                    <div id="resultsSectionScaler" class="hidden">
                        <h3 class="text-lg font-bold text-primary mb-4 pb-2 border-b border-default">Generated Assets</h3>
                        <div id="resultsDivScaler" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                            <!-- Dynamic Content -->
                        </div>
                    </div>
                </div>
                
                <!-- TOOL 4: FORMATTER -->
                <div id="tool-formatter" class="tool-section hidden">
                     <div class="mb-8">
                        <h2 class="text-3xl font-bold text-primary mb-2">HTML Formatter</h2>
                        <p class="text-secondary text-lg">Beautify messy HTML code with proper indentation and spacing.</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 h-[calc(100vh-240px)] min-h-[500px]">
                        <div class="tool-card flex flex-col h-full overflow-hidden shadow-md">
                            <div class="p-4 border-b border-default bg-gray-50 dark:bg-slate-800 flex justify-between items-center">
                                <label class="text-xs font-bold text-secondary uppercase tracking-wide">Input (Messy)</label>
                                <i class="fas fa-code text-gray-400"></i>
                            </div>
                            <textarea id="htmlInput" class="flex-1 w-full p-5 font-mono text-xs bg-input border-none outline-none resize-none focus:ring-0" placeholder="Paste HTML here..."></textarea>
                        </div>

                        <div class="tool-card flex flex-col h-full overflow-hidden shadow-md relative">
                             <div class="p-4 border-b border-default bg-gray-50 dark:bg-slate-800 flex justify-between items-center">
                                <label class="text-xs font-bold text-secondary uppercase tracking-wide">Output (Clean)</label>
                                <button id="copyHtmlButton" disabled class="text-xs font-bold text-accent hover:text-accent-hover disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 transition-colors">
                                    <i class="fas fa-copy"></i> Copy
                                </button>
                            </div>
                            <textarea id="formattedOutput" readonly class="flex-1 w-full p-5 font-mono text-xs bg-input border-none outline-none resize-none focus:ring-0"></textarea>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Hidden Elements -->
    <canvas id="conversion-canvas" class="hidden"></canvas>
    <canvas id="image-conversion-canvas" class="hidden"></canvas>

    <!-- Notifications -->
    <div id="message-box" class="fixed bottom-6 right-6 px-6 py-4 bg-gray-900 text-white rounded-xl shadow-2xl hidden transform transition-all duration-300 z-50 flex items-center gap-3 border border-gray-700">
        <i class="fas fa-info-circle text-accent text-lg"></i>
        <span id="message-text" class="font-medium">Notification</span>
    </div>

    <!-- File Name Modal -->
    <div id="filename-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden flex items-center justify-center z-50">
        <div class="tool-card p-8 rounded-2xl w-full max-w-md shadow-2xl transform transition-all scale-100">
            <h3 class="text-2xl font-bold mb-2 text-primary">Save Image</h3>
            <p class="text-sm text-secondary mb-6">Enter a filename for your clipboard image.</p>
            <input type="text" id="filename-input" class="w-full p-4 border border-default bg-input rounded-xl mb-6 focus:ring-2 focus:ring-accent focus:border-accent text-primary font-medium" placeholder="clipboard-image">
            <div class="flex justify-end gap-3">
                <button id="filename-cancel" class="px-5 py-2.5 text-secondary hover:bg-gray-100 dark:hover:bg-slate-700 rounded-xl font-bold transition-colors">Cancel</button>
                <button id="filename-confirm" class="px-6 py-2.5 bg-accent hover:bg-accent-hover text-white rounded-xl font-bold shadow-lg shadow-green-900/20 transition-all transform active:scale-95">Download</button>
            </div>
        </div>
    </div>

    <script>
        // --- STATE & NAVIGATION ---
        const TABS = ['resizer', 'compressor', 'scaler', 'formatter'];
        let activeTab = 'resizer';

        function switchTab(tabId) {
            activeTab = tabId;
            localStorage.setItem('activeTab', tabId);
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
                const icon = el.querySelector('i');
                if(icon) icon.classList.remove('text-accent');
            });
            
            const activeNav = document.getElementById(`nav-${tabId}`);
            if(activeNav) {
                activeNav.classList.add('active');
                const icon = activeNav.querySelector('i');
                if(icon) icon.classList.add('text-accent');
            }

            document.querySelectorAll('.tool-section').forEach(el => el.classList.add('hidden'));
            const activeSection = document.getElementById(`tool-${tabId}`);
            if(activeSection) activeSection.classList.remove('hidden');
        }

        function initApp() {
            // Load Theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            const themeToggle = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const disabler = document.getElementById('initial-transition-disabler'); // Reference to the temporary style tag
            
            // 1. Immediately apply the stored theme without transition
            if(savedTheme === 'dark') {
                document.documentElement.classList.add('dark');
                if(themeIcon) themeIcon.className = 'fas fa-sun text-yellow-400';
            }

            // 2. Remove the transition disabler after a short delay (or immediately after setup)
            if (disabler) {
                 // Use a small delay to ensure theme is applied before re-enabling transitions
                setTimeout(() => {
                    disabler.remove();
                }, 100); 
            }

            // Load Tab
            const savedTab = localStorage.getItem('activeTab');
            if(TABS.includes(savedTab)) {
                switchTab(savedTab);
            } else {
                switchTab('resizer');
            }

            // Mobile Menu
            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                const sidebar = document.querySelector('aside');
                sidebar.classList.toggle('hidden');
                sidebar.classList.toggle('absolute');
                sidebar.classList.toggle('h-full');
                sidebar.classList.toggle('w-64');
            });
            
            // Setup Theme Toggle
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    document.documentElement.classList.toggle('dark');
                    const isDark = document.documentElement.classList.contains('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    if(themeIcon) themeIcon.className = isDark ? 'fas fa-sun text-yellow-400' : 'fas fa-moon';
                });
            }
        }

        // --- SHARED UTILS ---
        function showMessage(msg, isError = false) {
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-text');
            const icon = box.querySelector('i');
            
            text.textContent = msg;
            icon.className = isError ? 'fas fa-exclamation-circle text-red-400 text-xl' : 'fas fa-check-circle text-green-400 text-xl';
            
            box.classList.remove('hidden', 'translate-y-10', 'opacity-0');
            setTimeout(() => {
                box.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 4000);
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // --- TOOL 1: RESIZER LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const dom = {
                upload: document.getElementById('svg-upload'),
                display: document.getElementById('svg-display'),
                controls: document.getElementById('processing-area'),
                wRange: document.getElementById('width-range'), wInput: document.getElementById('width-input'),
                hRange: document.getElementById('height-range'), hInput: document.getElementById('height-input'),
                lock: document.getElementById('lock-aspect'),
                cLeftR: document.getElementById('crop-left-range'), cLeftI: document.getElementById('crop-left-input'),
                cRightR: document.getElementById('crop-right-range'), cRightI: document.getElementById('crop-right-input'),
                cTopR: document.getElementById('crop-top-range'), cTopI: document.getElementById('crop-top-input'),
                cBotR: document.getElementById('crop-bottom-range'), cBotI: document.getElementById('crop-bottom-input'),
                rRange: document.getElementById('rounded-range'), rInput: document.getElementById('rounded-input'),
                dlBtn: document.getElementById('download-button'), cpBtn: document.getElementById('copy-button'),
                canvas: document.getElementById('conversion-canvas')
            };

            let state = { svgContent: null, aspect: 1, name: 'image' };
            const MAX = 6000;

            if (dom.upload) {
                dom.upload.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if(!file) return;
                    state.name = file.name.replace(/\.svg$/i, '');
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        state.svgContent = ev.target.result;
                        dom.display.innerHTML = state.svgContent;
                        const svg = dom.display.querySelector('svg');
                        svg.setAttribute('width', '100%');
                        svg.setAttribute('height', '100%');

                        const w = svg.getAttribute('viewBox') ? svg.viewBox.baseVal.width : 500;
                        const h = svg.getAttribute('viewBox') ? svg.viewBox.baseVal.height : 500;
                        state.aspect = w / h;
                        updateDim(w, h);
                        if (dom.controls) dom.controls.classList.remove('opacity-50', 'pointer-events-none');
                        if (dom.dlBtn) dom.dlBtn.disabled = false;
                        if (dom.cpBtn) dom.cpBtn.disabled = false;
                        [dom.cLeftI, dom.cRightI, dom.cTopI, dom.cBotI, dom.cLeftR, dom.cRightR, dom.cTopR, dom.cBotR].forEach(el => { if (el) el.value = 0; });
                        updatePreview();
                    };
                    reader.readAsText(file);
                });
            }

            function updateDim(w, h) {
                w = Math.min(MAX, Math.max(1, Math.round(w)));
                h = Math.min(MAX, Math.max(1, Math.round(h)));
                if(dom.wInput) dom.wInput.value = w; if(dom.wRange) dom.wRange.value = w;
                if(dom.hInput) dom.hInput.value = h; if(dom.hRange) dom.hRange.value = h;
            }

            function handleDimChange(e) {
                let w = parseInt(dom.wInput.value), h = parseInt(dom.hInput.value);
                const isWidth = (e.target === dom.wInput || e.target === dom.wRange);
                if(isWidth) w = parseInt(e.target.value); else h = parseInt(e.target.value);
                if(dom.lock && dom.lock.checked) { if(isWidth) h = Math.round(w / state.aspect); else w = Math.round(h * state.aspect); }
                updateDim(w, h);
                updatePreview();
            }

            function handleCropChange() {
                if(dom.cLeftI) dom.cLeftR.value = dom.cLeftI.value = Math.min(dom.cLeftI.value, parseInt(dom.wInput.value) - 1);
                if(dom.cRightI) dom.cRightR.value = dom.cRightI.value = Math.min(dom.cRightI.value, parseInt(dom.wInput.value) - 1);
                if(dom.cTopI) dom.cTopR.value = dom.cTopI.value = Math.min(dom.cTopI.value, parseInt(dom.hInput.value) - 1);
                if(dom.cBotI) dom.cBotR.value = dom.cBotI.value = Math.min(dom.cBotI.value, parseInt(dom.hInput.value) - 1);
                updatePreview();
            }
            
            function handleRoundChange(e) {
                if(dom.rInput) dom.rInput.value = e.target.value;
                if(dom.rRange) dom.rRange.value = e.target.value;
                updatePreview();
            }

            function updatePreview() {
                if(!state.svgContent || !dom.wInput || !dom.hInput) return;
                const w = parseInt(dom.wInput.value);
                const h = parseInt(dom.hInput.value);
                const cl = parseInt(dom.cLeftI.value)||0, cr = parseInt(dom.cRightI.value)||0;
                const ct = parseInt(dom.cTopI.value)||0, cb = parseInt(dom.cBotI.value)||0;
                const rad = parseInt(dom.rInput.value)||0;

                const finalW = Math.max(1, w - cl - cr);
                const finalH = Math.max(1, h - ct - cb);
                const svgEl = dom.display.querySelector('svg');
                
                if(svgEl) {
                    const maxPreview = 280;
                    const scale = Math.min(1, maxPreview/finalW, maxPreview/finalH);
                    dom.display.style.width = `${finalW * scale}px`;
                    dom.display.style.height = `${finalH * scale}px`;
                    dom.display.style.borderRadius = `${rad * scale}px`;
                    svgEl.style.width = `${w * scale}px`;
                    svgEl.style.height = `${h * scale}px`;
                    svgEl.style.marginLeft = `-${cl * scale}px`;
                    svgEl.style.marginTop = `-${ct * scale}px`;
                }
            }

            async function processImage() {
                const w = parseInt(dom.wInput.value);
                const h = parseInt(dom.hInput.value);
                const cl = parseInt(dom.cLeftI.value)||0, cr = parseInt(dom.cRightI.value)||0;
                const ct = parseInt(dom.cTopI.value)||0, cb = parseInt(dom.cBotI.value)||0;
                const rad = parseInt(dom.rInput.value)||0;
                const finalW = w - cl - cr;
                const finalH = h - ct - cb;

                dom.canvas.width = finalW;
                dom.canvas.height = finalH;
                const ctx = dom.canvas.getContext('2d');
                ctx.clearRect(0, 0, finalW, finalH);

                if(rad > 0) { 
                    // ctx.roundRect is not universally supported, using simplified path
                    ctx.beginPath();
                    ctx.moveTo(rad, 0);
                    ctx.arcTo(finalW, 0, finalW, finalH, rad);
                    ctx.arcTo(finalW, finalH, 0, finalH, rad);
                    ctx.arcTo(0, finalH, 0, 0, rad);
                    ctx.arcTo(0, 0, finalW, 0, rad);
                    ctx.closePath();
                    ctx.clip();
                }

                const img = new Image();
                let svgStr = state.svgContent;
                if(svgStr.includes('<svg')) {
                    svgStr = svgStr.replace(/<svg([^>]*)>/, (match) => {
                         let m = match.replace(/width="[^"]*"/i, '').replace(/height="[^"]*"/i, '');
                         return m.replace('<svg', `<svg width="${w}" height="${h}"`);
                    });
                }
                
                const svgBlob = new Blob([svgStr], {type: 'image/svg+xml;charset=utf-8'});
                const url = URL.createObjectURL(svgBlob);
                
                return new Promise((resolve) => {
                    img.onload = () => {
                        const tempCan = document.createElement('canvas');
                        tempCan.width = w; tempCan.height = h;
                        const tCtx = tempCan.getContext('2d');
                        tCtx.drawImage(img, 0, 0, w, h);
                        ctx.drawImage(tempCan, cl, ct, finalW, finalH, 0, 0, finalW, finalH);
                        URL.revokeObjectURL(url);
                        resolve(dom.canvas.toDataURL('image/png'));
                    };
                    img.src = url;
                });
            }

            if(dom.dlBtn) dom.dlBtn.addEventListener('click', async () => {
                dom.dlBtn.innerText = "Processing...";
                const dataUrl = await processImage();
                const a = document.createElement('a');
                a.href = dataUrl;
                a.download = `${state.name}-processed.png`;
                a.click();
                dom.dlBtn.innerText = "Download PNG";
                showMessage("Image downloaded!");
            });
            
            if(dom.cpBtn) dom.cpBtn.addEventListener('click', async () => {
                dom.cpBtn.innerText = "...";
                try {
                    const dataUrl = await processImage();
                    const blob = await (await fetch(dataUrl)).blob();
                    await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
                    showMessage("Copied to clipboard!");
                } catch(e) {
                    showMessage("Manual copy required. Right-click download instead.", true);
                }
                dom.cpBtn.innerText = "Copy Image";
            });

            [dom.wRange, dom.wInput, dom.hRange, dom.hInput].forEach(el => {if(el) el.addEventListener('input', handleDimChange)});
            [dom.cLeftR, dom.cLeftI, dom.cRightR, dom.cRightI, dom.cTopR, dom.cTopI, dom.cBotR, dom.cBotI]
                .forEach(el => {if(el) el.addEventListener('input', handleCropChange)});
            [dom.rRange, dom.rInput].forEach(el => {if(el) el.addEventListener('input', handleRoundChange)});
        });

        // --- TOOL 2: COMPRESSOR LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const up = document.getElementById('image-upload');
            const slider = document.getElementById('quality-slider');
            const btn = document.getElementById('download-compressed-button');
            const cvs = document.getElementById('image-conversion-canvas');
            let currentFile = null;

            if (up) up.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(file) {
                    currentFile = file;
                    const url = URL.createObjectURL(file);
                    document.getElementById('original-image-display').innerHTML = `<img src="${url}">`;
                    document.getElementById('compressor-processing-area').classList.remove('opacity-50', 'pointer-events-none');
                    compress();
                }
            });

            if (slider) slider.addEventListener('input', (e) => {
                document.getElementById('quality-value').innerText = `${e.target.value}%`;
                compress();
            });

            async function compress() {
                if(!currentFile) return;
                const q = parseInt(slider.value) / 100;
                const img = new Image();
                img.src = URL.createObjectURL(currentFile);
                await new Promise(r => img.onload = r);
                
                cvs.width = img.naturalWidth;
                cvs.height = img.naturalHeight;
                const ctx = cvs.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                const dataUrl = cvs.toDataURL('image/jpeg', q);
                document.getElementById('compressed-image-display').innerHTML = `<img src="${dataUrl}">`;
                
                const size = Math.round(dataUrl.length * 0.75); 
                const saved = ((1 - (size/currentFile.size)) * 100).toFixed(1);
                
                document.getElementById('file-size-display').innerHTML = 
                    `Original: <b>${formatBytes(currentFile.size)}</b> <i class="fas fa-arrow-right mx-2 text-gray-400"></i> Result: <b>${formatBytes(size)}</b> <span class="ml-2 text-accent">(-${saved}%)</span>`;
                    
                if (btn) btn.addEventListener('click', () => {
                    const a = document.createElement('a');
                    a.href = dataUrl;
                    a.download = `compressed-${currentFile.name.split('.')[0]}.jpg`;
                    a.click();
                }, {once: true});
                if (btn) btn.disabled = false;
            }
        });

        // --- TOOL 3: SCALER LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('convertButtonScaler');
            const input = document.getElementById('svgInputScaler');
            const container = document.getElementById('resultsDivScaler');
            
            const uploadBtn = document.getElementById('uploadButtonScaler');
            const fileInput = document.getElementById('svgFileUploaderScaler');

            if (uploadBtn) uploadBtn.addEventListener('click', () => { if (fileInput) fileInput.click(); });
            
            if (fileInput) fileInput.addEventListener('change', (e) => {
                const r = new FileReader();
                r.onload = ev => { if (input) input.value = ev.target.result; };
                if (e.target.files[0]) r.readAsText(e.target.files[0]);
            });

            if (btn) btn.addEventListener('click', async () => {
                container.innerHTML = '';
                const svg = input.value;
                if(!svg.trim()) return;
                
                document.getElementById('resultsSectionScaler').classList.remove('hidden');
                
                const scales = [2, 4, 8, 16];
                const parser = new DOMParser();
                const doc = parser.parseFromString(svg, 'image/svg+xml');
                const baseW = parseFloat(doc.documentElement.getAttribute('width') || 32);
                const baseH = parseFloat(doc.documentElement.getAttribute('height') || 32);

                for(let s of scales) {
                    const w = baseW * s;
                    const h = baseH * s;
                    const cvs = document.createElement('canvas');
                    cvs.width = w; cvs.height = h;
                    const ctx = cvs.getContext('2d');
                    
                    const img = new Image();
                    const blob = new Blob([svg], {type: 'image/svg+xml'});
                    img.src = URL.createObjectURL(blob);
                    
                    await new Promise(r => img.onload = r);
                    
                    ctx.drawImage(img, 0, 0, w, h);
                    const url = cvs.toDataURL('image/png');
                    
                    const div = document.createElement('div');
                    div.className = 'flex flex-col items-center p-4 bg-gray-50 dark:bg-slate-700 rounded-lg border border-default';
                    div.innerHTML = `
                        <div class="h-32 flex items-center justify-center mb-3"><img src="${url}" class="max-h-full shadow-sm"></div>
                        <div class="text-xs font-bold text-primary mb-2">${s}x (${w}x${h})</div>
                        <button class="copy-btn-scaler text-xs bg-white dark:bg-slate-600 border border-default px-3 py-1 rounded hover:bg-gray-50 transition-colors text-primary">Copy PNG</button>
                    `;
                    
                    div.querySelector('.copy-btn-scaler').addEventListener('click', async () => {
                         try {
                            const b = await (await fetch(url)).blob();
                            await navigator.clipboard.write([new ClipboardItem({'image/png': b})]);
                            showMessage("Copied!");
                         } catch(e) {
                            showMessage("Copy failed.", true);
                         }
                    });
                    container.appendChild(div);
                }
            });
        });

        // --- TOOL 4: FORMATTER LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('copyHtmlButton');
            const input = document.getElementById('htmlInput');
            const output = document.getElementById('formattedOutput');
            
            if(btn && input && output) {
                input.addEventListener('input', () => {
                    function formatHTML(html) {
                        let formatted = '';
                        const reg = /(>)(<)(\/*)/g;
                        html = html.replace(reg, '$1\r\n$2$3');
                        let pad = 0;
                        html.split('\r\n').forEach(function(node) {
                            let indent = 0;
                            if (node.match(/.+<\/\w[^>]*>$/)) indent = 0;
                            else if (node.match(/^<\/\w/)) { if (pad !== 0) pad -= 1; }
                            else if (node.match(/^<\w[^>]*[^\/]>.*$/)) indent = 1;
                            else indent = 0;

                            let padding = '';
                            for (let i = 0; i < pad; i++) { padding += '  '; }
                            formatted += padding + node + '\r\n';
                            pad += indent;
                        });
                        return formatted;
                    }
                    output.value = formatHTML(input.value);
                    btn.disabled = false;
                });
                
                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(output.value);
                    showMessage("HTML Copied!");
                });
            }
        });

        // --- CLIPBOARD FEATURE ---
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('filename-modal');
            let clipBlob = null;
            const clipBtn = document.getElementById('clipboard-download-button');
            const cancelBtn = document.getElementById('filename-cancel');
            const confirmBtn = document.getElementById('filename-confirm');

            if (clipBtn) {
                clipBtn.addEventListener('click', async () => {
                    try {
                        const items = await navigator.clipboard.read();
                        let found = false;
                        for (let item of items) {
                            if (item.types.includes("image/png")) {
                                clipBlob = await item.getType("image/png");
                                found = true;
                                break;
                            }
                        }
                        if(found) {
                            const img = new Image();
                            img.src = URL.createObjectURL(clipBlob);
                            await new Promise(r => img.onload = r);
                            const cvs = document.createElement('canvas');
                            cvs.width = img.width; cvs.height = img.height;
                            cvs.getContext('2d').drawImage(img, 0, 0);
                            
                            cvs.toBlob(b => {
                                clipBlob = b;
                                modal.classList.remove('hidden');
                                document.getElementById('filename-input').focus();
                            }, 'image/png');
                        } else {
                            showMessage("No image found in clipboard", true);
                        }
                    } catch (e) {
                        showMessage("Clipboard access denied (Click Button to enable)", true);
                    }
                });
            }
            
            if (cancelBtn) cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
            if (confirmBtn) confirmBtn.addEventListener('click', () => {
                const name = document.getElementById('filename-input').value || 'clipboard';
                const a = document.createElement('a');
                a.href = URL.createObjectURL(clipBlob);
                a.download = name + '.png';
                a.click();
                modal.classList.add('hidden');
                showMessage("Downloaded!");
            });

            // Shortcuts
            document.addEventListener('keydown', (e) => {
                if((e.ctrlKey || e.metaKey) && e.key === 'v' && e.target.tagName === 'BODY') {
                    e.preventDefault();
                    if(clipBtn) clipBtn.click();
                }
            });
        });
        
        initApp();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageTools v1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Base Aesthetic (Google Light Mode) */
        body {
            font-family: 'Google Sans', sans-serif; 
            min-height: 100vh;
            background-color: #f8f9fa; /* Very light grey */
            color: #1f2937; /* Dark text */
        }
        .tool-card {
            background-color: #ffffff; /* White card background */
            border: 1px solid #e0e0e0; /* Added subtle border for definition */
        }
        
        /* --- Tool 1: SVG Resizer Styles (#34A853 Accent) --- */
        
        #svg-display {
            min-height: 200px; 
            border: 2px dashed #cccccc;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0; 
            overflow: hidden;
        }
        #svg-display > p {
            color: #888888;
        }
        #svg-display > svg {
            max-width: 100%;
            max-height: 100%;
            width: auto !important; 
            height: auto !important;
        }
        
        /* Resizer Pulse Outline Animation (#34A853) */
        @keyframes pulse-resizer {
            0%, 100% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(52, 168, 83, 0); }
        }
        .pulse-outline-resizer {
            animation: pulse-resizer 2s infinite;
            border: 2px solid #34A853; 
        }

        /* Generic Slider Track (#e0e0e0) and Thumb (#000000) */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            width: 100%;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background: #e0e0e0;
            border-radius: 4px;
            height: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px; height: 18px;
            background: #000000;
            cursor: pointer;
            border-radius: 9999px;
            margin-top: -7px;
            box-shadow: 0 0 8px #34A853; /* Default Accent Glow */
        }
        input[type=range]::-moz-range-track { background: #e0e0e0; height: 4px; border-radius: 4px;}
        input[type=range]::-moz-range-thumb {
            background: #000000;
            border: none;
            width: 18px; height: 18px;
            border-radius: 9999px;
            box-shadow: 0 0 8px #34A853;
        }

        /* --- Tool 2: Image Compressor Styles --- */
        .image-preview-box {
            min-height: 200px;
            border: 2px dashed #cccccc;
            background-color: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .image-preview-box img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        /* --- Tool 3: Icon Scaler Styles (Turquoise/Lime Gradient) --- */
        
        /* Custom scrollbar for the textarea for light mode */
        #svgInputScaler::-webkit-scrollbar { width: 8px; }
        #svgInputScaler::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }
        #svgInputScaler::-webkit-scrollbar-track { background: #f3f4f6; }

        /* Styling for generated images */
        .scaled-image {
            border: 1px solid #d1d5db;
            image-rendering: pixelated; 
        }

        /* --- Collapsible Title Style --- */
        .tool-title {
            cursor: pointer;
            padding: 1.5rem;
            margin-bottom: 0 !important;
            border-radius: 0.75rem 0.75rem 0 0;
            transition: background-color 0.15s;
            border-bottom: 1px solid #e0e0e0;
        }
        .tool-title:hover {
            background-color: #f0f0f0; /* Applied to all titles for consistency */
        }
        
    </style>
</head>
<body class="p-4 sm:p-8">

    <h1 class="text-4xl font-bold text-center text-[#34A853] mb-8">ImageTools v1</h1>

    <!-- CLIPBOARD DOWNLOAD FEATURE -->
    <div class="max-w-4xl mx-auto">
        <div class="mb-8 max-w-lg">
            <button id="clipboard-download-button" 
                    class="tool-card p-4 rounded-xl border-2 border-[#34A853] 
                           w-full text-left flex flex-col items-start 
                           bg-white hover:bg-gray-100 transition duration-150 group" 
                    style="cursor: pointer;">
                
                <span class="text-lg font-bold text-gray-700 group-hover:text-[#34A853] transition-colors duration-150">
                    <i class="fas fa-clipboard pr-2"></i> Convert Clipboard to Image
                </span>
                <span class="text-xs font-normal text-gray-500 mt-1">
                    Click to immediately download the image copied to your clipboard.
                </span>
            </button>
        </div>
    </div>
    <!-- END NEW FEATURE -->

    <div id="app-container" class="max-w-4xl mx-auto space-y-8">
        
        <!-- ============================================== -->
        <!-- TOOL 1: SVG RESIZER & PNG CONVERTER (#34A853) -->
        <!-- Default state changed to CLOSED (hidden and rotate-90) -->
        <!-- ============================================== -->
        <div class="tool-card rounded-xl">
             <h1 class="tool-title text-2xl font-extrabold mb-0 rounded-b-none text-[#34A853] flex justify-between items-center" onclick="toggleTool('resizer-content', this)">
                <div>
                    <span>SVG Resizer & PNG Converter</span>
                    <p class="text-sm font-normal text-gray-600 mt-1">Upload an SVG file, change the resolution, and download it as a PNG.</p>
                </div>
                <span class="collapse-icon transform transition-transform duration-300 rotate-90">
                    <svg class="w-6 h-6 text-[#34A853]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </span>
            </h1>

            <div id="resizer-content" class="p-6 sm:p-8 space-y-8 hidden">
                <!-- Upload Area -->
                <section>
                    <label for="svg-upload" class="block text-lg font-medium mb-4 text-[#1f2937]">Upload SVG File:</label>
                    <div id="svg-display" class="rounded-lg mb-4">
                        <p>Preview will appear here</p>
                    </div>
                    <input type="file" id="svg-upload" accept=".svg,image/svg+xml" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer"/>
                </section>
                
                <!-- Processing Area (initially disabled) -->
                <section id="processing-area" class="opacity-50 pointer-events-none space-y-6">
                    <h2 class="text-lg font-medium text-[#1f2937]">Adjust Dimensions (pixels):</h2>
                    <!-- Width Controls -->
                    <div class="grid grid-cols-[auto,1fr,auto] gap-x-4 items-center">
                        <label for="width-input" class="font-semibold">Width</label>
                        <input type="range" id="width-range" min="1" max="6000" value="500" class="w-full">
                        <div class="flex items-center space-x-2">
                           <input type="number" id="width-input" min="1" max="6000" value="500" class="w-24 p-2 border border-gray-300 rounded-md text-center">
                        </div>
                    </div>
                     <!-- Height Controls -->
                    <div class="grid grid-cols-[auto,1fr,auto] gap-x-4 items-center">
                        <label for="height-input" class="font-semibold">Height</label>
                        <input type="range" id="height-range" min="1" max="6000" value="500" class="w-full">
                        <div class="flex items-center space-x-2">
                           <input type="number" id="height-input" min="1" max="6000" value="500" class="w-24 p-2 border border-gray-300 rounded-md text-center">
                        </div>
                    </div>
                    <!-- Rounded Edge Controls -->
                    <div class="grid grid-cols-[auto,1fr,auto] gap-x-4 items-center">
                        <label for="rounded-input" class="font-semibold">Rounding (px)</label>
                        <input type="range" id="rounded-range" min="0" max="500" value="0" class="w-full">
                        <div class="flex items-center space-x-2">
                           <input type="number" id="rounded-input" min="0" max="500" value="0" class="w-24 p-2 border border-gray-300 rounded-md text-center">
                        </div>
                    </div>
                    <!-- Aspect Lock & Steppers -->
                    <div class="flex justify-between items-center">
                         <div class="flex items-center space-x-2">
                            <span class="text-sm font-medium mr-2">Adjust:</span>
                            <button data-target="width" data-step="-10" class="step-button-resizer p-2 rounded-md bg-gray-200 hover:bg-gray-300 w-10 h-8 flex items-center justify-center">-10</button>
                            <button data-target="width" data-step="-1" class="step-button-resizer p-2 rounded-md bg-gray-200 hover:bg-gray-300 w-10 h-8 flex items-center justify-center">-1</button>
                            <button data-target="width" data-step="1" class="step-button-resizer p-2 rounded-md bg-gray-200 hover:bg-gray-300 w-10 h-8 flex items-center justify-center">+1</button>
                            <button data-target="width" data-step="10" class="step-button-resizer p-2 rounded-md bg-gray-200 hover:bg-gray-300 w-10 h-8 flex items-center justify-center">+10</button>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="lock-aspect" class="h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500" checked>
                            <label for="lock-aspect" class="ml-2 block text-sm text-gray-900">Lock Aspect Ratio</label>
                        </div>
                    </div>
                </section>

                <!-- Action Buttons -->
                <section class="flex flex-col sm:flex-row gap-4">
                    <button id="copy-button" class="flex-1 px-6 py-3 bg-gray-700 text-white font-bold rounded-lg hover:bg-gray-800 transition-colors duration-150 disabled:opacity-50" disabled>Copy to Clipboard</button>
                    <button id="download-button" class="flex-1 px-6 py-3 bg-[#34A853] text-white font-bold rounded-lg hover:bg-[#2c8d48] transition-colors duration-150 disabled:opacity-50" disabled>Download as PNG</button>
                </section>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- TOOL 2: IMAGE COMPRESSOR (#34A853) -->
        <!-- Default state: CLOSED (hidden and rotate-90) -->
        <!-- ============================================== -->
        <div class="tool-card rounded-xl">
             <h1 class="tool-title text-2xl font-extrabold mb-0 rounded-b-none text-[#34A853] flex justify-between items-center" onclick="toggleTool('compressor-content', this)">
                <div>
                    <span>Image Compressor</span>
                    <p class="text-sm font-normal text-gray-600 mt-1">Upload an image, adjust the quality, and download a smaller file.</p>
                </div>
                <span class="collapse-icon transform transition-transform duration-300 rotate-90">
                    <svg class="w-6 h-6 text-[#34A853]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </span>
            </h1>

            <div id="compressor-content" class="p-6 sm:p-8 space-y-8 hidden">
                <!-- Upload Area & Previews -->
                <section>
                    <label for="image-upload" class="block text-lg font-medium mb-4 text-[#1f2937]">Upload Image (JPG/PNG):</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <h3 class="text-center font-semibold mb-2">Original</h3>
                            <div id="original-image-display" class="image-preview-box rounded-lg"><p class="text-gray-500 p-4 text-center">Upload an image to see the original</p></div>
                        </div>
                        <div>
                            <h3 class="text-center font-semibold mb-2">Compressed</h3>
                             <div id="compressed-image-display" class="image-preview-box rounded-lg"><p class="text-gray-500 p-4 text-center">Compressed result will appear here</p></div>
                        </div>
                    </div>
                    <input type="file" id="image-upload" accept="image/jpeg,image/png" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100 cursor-pointer"/>
                </section>

                <!-- Compressor Controls -->
                <section id="compressor-processing-area" class="opacity-50 pointer-events-none space-y-4">
                     <div class="grid grid-cols-[auto,1fr,auto] gap-x-4 items-center">
                        <label for="quality-slider" class="font-semibold">Quality</label>
                        <input type="range" id="quality-slider" min="0" max="100" value="75" class="w-full">
                        <span id="quality-value" class="font-mono w-12 text-center">75%</span>
                    </div>
                    <div id="file-size-display" class="text-center text-sm font-medium text-gray-700 p-2 bg-gray-100 rounded-md">
                        File size info will appear here.
                    </div>
                </section>
                
                <!-- Action Button -->
                <section>
                    <button id="download-compressed-button" class="w-full px-6 py-3 bg-[#34A853] text-white font-bold rounded-lg hover:bg-[#2c8d48] transition-colors duration-150 disabled:opacity-50" disabled>Download Compressed Image</button>
                </section>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- TOOL 3: ICON SCALER (2x, 4x, 8x, 16x) -->
        <!-- Default state: CLOSED (hidden and rotate-90) -->
        <!-- ============================================== -->
        <div class="tool-card rounded-xl">
             <h1 class="tool-title text-2xl font-extrabold mb-0 rounded-b-none text-[#34A853] flex justify-between items-center" onclick="toggleTool('scaler-content', this)">
                <div>
                    <span>SVG Icon Resizer</span>
                    <p class="text-sm font-normal text-gray-600 mt-1">Paste in SVG code or SVG, and you can resize your icons! Or, paste in the coordinate SVG code to visualize the icon so you can save it as an image.</p>
                </div>
                <span class="collapse-icon transform transition-transform duration-300 rotate-90">
                    <svg class="w-6 h-6 text-[#34A853]" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </span>
            </h1>

            <div id="scaler-content" class="p-6 sm:p-8 space-y-8 hidden">
                
                <section class="mb-8">
                    <label for="svgInputScaler" class="block text-lg font-medium mb-2 text-[#1f2937]">Paste SVG Code Here:</label>
                    <textarea id="svgInputScaler" rows="8" placeholder="<svg viewBox='0 0 32 32' ...>"
                        class="w-full p-4 bg-[#f9fafb] border border-[#cccccc] rounded-lg focus:ring-2 focus:ring-[#34A853] focus:border-[#34A853] outline-none text-[#1f2937] text-sm transition duration-150 ease-in-out"></textarea>
                    
                    <div class="mt-4 flex items-center justify-between space-x-4">
                        <p class="text-[#6b7280] text-sm hidden sm:block"></p>
                        <input type="file" id="svgFileUploaderScaler" accept=".svg,image/svg+xml" class="hidden">
                        <button id="uploadButtonScaler" 
                            class="flex-1 w-full px-4 py-2 text-[#1f2937] font-bold rounded-lg border border-[#cccccc] hover:bg-[#f0f0f0] transition duration-150 ease-in-out">
                            <span class="mr-2 text-lg">📁</span> Upload SVG
                        </button>
                        <p class="text-[#6b7280] text-sm hidden sm:block"></p>
                    </div>

                    <button id="convertButtonScaler" 
                        class="mt-4 w-full md:w-auto px-6 py-3 bg-[#34A853] text-white font-bold rounded-lg hover:bg-[#2c8d48] transition-colors duration-150">
                        Generate Scaled PNGs
                    </button>
                </section>

                <section id="resultsSectionScaler" class="mt-8">
                    <h2 class="text-xl font-semibold mb-6 text-[#1f2937]" id="resultsTitleScaler" style="display: none;">Generated Scaled Images</h2>
                    <div id="resultsDivScaler" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    </div>
                </section>
            </div>
        </div>
    </div>

    <footer class="text-center text-gray-500 text-sm mt-12">
        Made by Christopher Gammello - For any fixes or changes please contact via cgammello@cb-retail.com
    </footer>

    <!-- Hidden canvases for conversion -->
    <canvas id="conversion-canvas" class="hidden"></canvas>
    <canvas id="image-conversion-canvas" class="hidden"></canvas>

    <!-- Message boxes for notifications -->
    <div id="message-box" class="fixed bottom-4 left-4 p-4 rounded-lg hidden transition-opacity duration-300 z-50" 
        style="background-color: #1f2937; color: #f3f4f6;">
        Message...
    </div>
    <div id="messageBoxScaler" class="fixed bottom-4 right-4 p-4 rounded-lg hidden transition-opacity duration-300 z-50" 
        style="background-color: #1f2937; color: #f3f4f6;">
        Message...
    </div>

    <script type="text/javascript">
        
        // ===============================================
        // GLOBAL FUNCTIONS & STATE MANAGEMENT
        // ===============================================
        
        const TOOL_STORAGE_KEY = 'toolStates';
        const TOOL_IDS = ['resizer-content', 'compressor-content', 'scaler-content'];

        /**
         * Saves the current open/closed state of all managed tools to localStorage.
         */
        function saveToolState() {
            const states = {};
            TOOL_IDS.forEach(id => {
                const content = document.getElementById(id);
                if (content) {
                    states[id] = !content.classList.contains('hidden'); // true if visible (open)
                }
            });
            try {
                localStorage.setItem(TOOL_STORAGE_KEY, JSON.stringify(states));
            } catch (e) {
                console.warn("localStorage is blocked or full. Cannot save tool state.", e);
            }
        }

        /**
         * Loads and applies the saved open/closed state of tools from localStorage.
         */
        function loadToolState() {
            try {
                const storedStates = JSON.parse(localStorage.getItem(TOOL_STORAGE_KEY));
                if (!storedStates) return;

                TOOL_IDS.forEach(id => {
                    const content = document.getElementById(id);
                    // Find the parent's h1 title (previous sibling)
                    const titleElement = content.parentElement.querySelector('.tool-title'); 
                    const icon = titleElement ? titleElement.querySelector('.collapse-icon') : null;
                    
                    // If state is saved as open (true)
                    if (storedStates[id] === true) {
                        content.classList.remove('hidden');
                        if (icon) icon.classList.remove('rotate-90');
                    } 
                    // If state is saved as closed (false)
                    else if (storedStates[id] === false) {
                        content.classList.add('hidden');
                        if (icon) icon.classList.add('rotate-90');
                    }
                });
            } catch (e) {
                console.error("Error loading tool state from localStorage.", e);
            }
        }

        /**
         * Toggles the visibility of a tool's content, rotates the arrow icon, and saves the state.
         */
        function toggleTool(contentId, titleElement) {
            const content = document.getElementById(contentId);
            if (content) {
                const icon = titleElement.querySelector('.collapse-icon');
                
                if (content.classList.contains('hidden')) {
                    content.classList.remove('hidden');
                    if (icon) icon.classList.remove('rotate-90');
                } else {
                    content.classList.add('hidden');
                    if (icon) icon.classList.add('rotate-90');
                }
                
                // Save the new state immediately after toggling
                saveToolState(); 
            }
        }
        
        /**
         * Formats bytes into a human-readable string (KB, MB).
         */
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        /**
         * Displays a temporary message in the main message box (bottom left).
         */
        function showMessage(message, isError = false) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.style.backgroundColor = isError ? '#ef4444' : '#1f2937';
            messageBox.classList.remove('hidden');
            clearTimeout(messageBox.timeout);
            messageBox.timeout = setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        /**
         * Displays a temporary message in the Scaler message box (bottom right).
         */
        function showMessageScaler(message, isError = false) {
            const messageBoxScaler = document.getElementById('messageBoxScaler');
            messageBoxScaler.textContent = message;
            messageBoxScaler.style.backgroundColor = isError ? '#ef4444' : '#1f2937';
            messageBoxScaler.classList.remove('hidden');
            setTimeout(() => messageBoxScaler.classList.add('hidden'), 3000);
        }
        
        // ===============================================
        // CLIPBOARD DOWNLOAD LOGIC
        // ===============================================
        {
            const clipboardDownloadButton = document.getElementById('clipboard-download-button');

            async function clipboardToImageDownload() {
                const titleSpan = clipboardDownloadButton.querySelector('span:first-child');
                clipboardDownloadButton.disabled = true;
                titleSpan.innerHTML = '<i class="fas fa-spinner fa-spin pr-2"></i> Reading Clipboard... (Requires Permission)';

                try {
                    if (!navigator.clipboard || !navigator.clipboard.read) {
                        throw new Error("Clipboard API not fully supported or accessible.");
                    }

                    const items = await navigator.clipboard.read();
                    
                    let imageItem = null;
                    for (const item of items) {
                        if (item.types.includes('image/png')) {
                            imageItem = item;
                            break;
                        } else if (item.types.includes('image/jpeg')) {
                            imageItem = item;
                        }
                    }

                    if (!imageItem) {
                        throw new Error("Clipboard does not contain image data (PNG/JPEG).");
                    }

                    showMessage('Image data found. Preparing download...');
                    
                    const blob = await imageItem.getType(imageItem.types[0]); 
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `clipboard-image-${new Date().getTime()}.png`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                    showMessage('Image downloaded successfully!');

                } catch (error) {
                    if (error.name === 'NotAllowedError') {
                         showMessage('Permission denied. Please ensure you clicked the button immediately after copying the image.', true);
                    } else {
                         showMessage(`Download failed: ${error.message}`, true);
                         console.error("Clipboard Download Error:", error);
                    }
                } finally {
                    clipboardDownloadButton.disabled = false;
                    titleSpan.innerHTML = '<i class="fas fa-clipboard pr-2"></i> Convert Clipboard to Image';
                }
            }
            
            clipboardDownloadButton.addEventListener('click', clipboardToImageDownload);
        }

        // ===============================================
        // TOOL 1: SVG RESIZER LOGIC
        // ===============================================
        {
            const svgUpload = document.getElementById('svg-upload');
            const svgDisplay = document.getElementById('svg-display');
            const widthRange = document.getElementById('width-range');
            const heightRange = document.getElementById('height-range');
            const widthInput = document.getElementById('width-input');
            const heightInput = document.getElementById('height-input');
            const lockAspect = document.getElementById('lock-aspect');
            const downloadButton = document.getElementById('download-button');
            const copyButton = document.getElementById('copy-button');
            const conversionCanvas = document.getElementById('conversion-canvas');
            const processingArea = document.getElementById('processing-area');
            const stepButtonsResizer = document.querySelectorAll('.step-button-resizer');
            const roundedRange = document.getElementById('rounded-range');
            const roundedInput = document.getElementById('rounded-input');

            let svgData = { content: null, originalWidth: 0, originalHeight: 0, aspectRatio: 1, fileName: 'resized-svg' };
            const MAX_DIMENSION = 6000;
            
            function getSvgDimensions(svgString) {
                const widthMatch = svgString.match(/width="(\d+\.?\d*)"/i);
                const heightMatch = svgString.match(/height="(\d+\.?\d*)"/i);
                const viewBoxMatch = svgString.match(/viewBox="[^"]*"/i);
                if (viewBoxMatch) {
                    const parts = viewBoxMatch[0].slice(9, -1).split(/[,\s]+/);
                    if (parts.length === 4) return { width: Math.max(1, Math.round(parseFloat(parts[2]))), height: Math.max(1, Math.round(parseFloat(parts[3])))};
                }
                if (widthMatch && heightMatch) return { width: Math.max(1, Math.round(parseFloat(widthMatch[1]))), height: Math.max(1, Math.round(parseFloat(heightMatch[1])))};
                return { width: 500, height: 500 };
            }

            function updateDisplay(w, h) {
                widthInput.value = w;
                widthRange.value = w;
                heightInput.value = h;
                heightRange.value = h;
            }

            function updatePreviewRounding() {
                if (!svgData.content) return;
                const radiusValue = parseInt(roundedInput.value) || 0;
                svgDisplay.style.borderRadius = `${radiusValue}px`;
            }

            async function performConversion() {
                if (!svgData.content) return null;
                let targetWidth = parseInt(widthInput.value) || 500;
                let targetHeight = parseInt(heightInput.value) || 500;
                targetWidth = Math.min(MAX_DIMENSION, Math.max(1, targetWidth));
                targetHeight = Math.min(MAX_DIMENSION, Math.max(1, targetHeight));
                updateDisplay(targetWidth, targetHeight);
                
                conversionCanvas.width = targetWidth;
                conversionCanvas.height = targetHeight;
                const ctx = conversionCanvas.getContext('2d');
                ctx.clearRect(0, 0, targetWidth, targetHeight);

                let radius = parseInt(roundedInput.value) || 0;
                radius = Math.min(radius, Math.min(targetWidth, targetHeight) / 2);

                if (radius > 0) {
                    ctx.beginPath();
                    ctx.moveTo(radius, 0);
                    ctx.arcTo(targetWidth, 0, targetWidth, targetHeight, radius);
                    ctx.arcTo(targetWidth, targetHeight, 0, targetHeight, radius);
                    ctx.arcTo(0, targetHeight, 0, 0, radius);
                    ctx.arcTo(0, 0, targetWidth, 0, radius);
                    ctx.closePath();
                    ctx.clip();
                }
                
                let svgContentForCanvas = svgData.content.replace(/<svg[^>]*>/, (match) => {
                    const xmlnsAttr = match.includes('xmlns') ? '' : ' xmlns="http://www.w3.org/2000/svg"';
                    return match.replace(/width="[^"]*"/, '').replace(/height="[^"]*"/, '').replace('>', `${xmlnsAttr} width="${targetWidth}" height="${targetHeight}">`);
                });
                
                const svgDataUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgContentForCanvas)));
                const img = new Image();
                img.crossOrigin = 'anonymous';

                return new Promise((resolve) => {
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
                        resolve(conversionCanvas.toDataURL('image/png'));
                    };
                    img.onerror = () => { showMessage('Failed to load SVG into image object.', true); resolve(null); };
                    img.src = svgDataUrl;
                });
            }

            svgUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || !file.type.includes('svg')) { showMessage('Please select a valid SVG file.', true); return; }

                svgData.fileName = file.name.replace(/\.svg$/i, '');
                const reader = new FileReader();
                reader.onload = (e) => {
                    svgData.content = e.target.result;
                    const { width, height } = getSvgDimensions(svgData.content);
                    svgData.originalWidth = width;
                    svgData.originalHeight = height;
                    svgData.aspectRatio = width / height;
                    svgDisplay.innerHTML = svgData.content;
                    
                    roundedInput.value = 0;
                    roundedRange.value = 0;
                    updatePreviewRounding();
                    const initialSize = Math.min(MAX_DIMENSION, Math.max(500, width)); 
                    updateDisplay(initialSize, Math.round(initialSize / svgData.aspectRatio));

                    processingArea.classList.remove('opacity-50', 'pointer-events-none');
                    downloadButton.disabled = false;
                    copyButton.disabled = false;
                    showMessage(`SVG "${svgData.fileName}" loaded!`);
                };
                reader.readAsText(file);
            });

            function handleResizeInput(e) {
                if (!svgData.content) return;
                const isWidthEvent = e.target === widthRange || e.target === widthInput;
                let val = parseInt(e.target.value) || 1;
                val = Math.min(MAX_DIMENSION, Math.max(1, val));
                let w = parseInt(widthInput.value), h = parseInt(heightInput.value);
                
                if (isWidthEvent) w = val; else h = val;
                
                if (lockAspect.checked) {
                    if (isWidthEvent) h = Math.round(w / svgData.aspectRatio);
                    else w = Math.round(h * svgData.aspectRatio);
                }
                updateDisplay(w, h);
                updatePreviewRounding();
            }
            
            function handleStepResizer(e) {
                if (!svgData.content) { showMessage('Upload an SVG first.', true); return; }
                const input = widthInput;
                input.value = Math.min(MAX_DIMENSION, Math.max(1, (parseInt(input.value) || 1) + parseInt(e.currentTarget.dataset.step)));
                handleResizeInput({ target: input });
            }
            
            async function triggerAction(isCopy) {
                const button = isCopy ? copyButton : downloadButton;
                const originalText = button.textContent;
                downloadButton.disabled = true; copyButton.disabled = true;
                button.textContent = 'Processing...';
                showMessage('Converting SVG to PNG...');
                const pngDataUrl = await performConversion();
                if (pngDataUrl) {
                    if (isCopy) {
                        try {
                            const blob = await (await fetch(pngDataUrl)).blob();
                            // Note: This is prone to 'NotAllowedError' in iframes, but we try anyway.
                            await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                            showMessage('PNG copied to clipboard!');
                        } catch (err) { 
                            showMessage('Copy failed. Please try the "Download" button and copy the resulting image manually.', true); 
                        }
                    } else {
                        const a = document.createElement('a');
                        a.href = pngDataUrl;
                        a.download = `${svgData.fileName}-${widthInput.value}x${heightInput.value}.png`;
                        a.click();
                        showMessage('PNG downloaded successfully!');
                    }
                }
                downloadButton.disabled = false; copyButton.disabled = false;
                button.textContent = originalText;
            }

            function handleRoundingInput(e) {
                let value = parseInt(e.target.value) || 0;
                roundedInput.value = value;
                roundedRange.value = value;
                updatePreviewRounding();
            }

            ['input', 'change'].forEach(evt => {
                widthRange.addEventListener(evt, handleResizeInput);
                heightRange.addEventListener(evt, handleResizeInput);
                widthInput.addEventListener(evt, handleResizeInput);
                heightInput.addEventListener(evt, handleResizeInput);
                roundedRange.addEventListener(evt, handleRoundingInput);
                roundedInput.addEventListener(evt, handleRoundingInput);
            });
            lockAspect.addEventListener('change', handleResizeInput);
            stepButtonsResizer.forEach(b => b.addEventListener('click', handleStepResizer));
            downloadButton.addEventListener('click', () => triggerAction(false));
            copyButton.addEventListener('click', () => triggerAction(true));
        }

        // ===============================================
        // TOOL 2: IMAGE COMPRESSOR LOGIC
        // ===============================================
        {
            const imageUpload = document.getElementById('image-upload');
            const originalImageDisplay = document.getElementById('original-image-display');
            const compressedImageDisplay = document.getElementById('compressed-image-display');
            const qualitySlider = document.getElementById('quality-slider');
            const qualityValue = document.getElementById('quality-value');
            const fileSizeDisplay = document.getElementById('file-size-display');
            const downloadCompressedButton = document.getElementById('download-compressed-button');
            const compressorProcessingArea = document.getElementById('compressor-processing-area');
            const imageConversionCanvas = document.getElementById('image-conversion-canvas');

            let imageData = {
                originalUrl: null,
                compressedUrl: null,
                originalSize: 0,
                fileName: 'image'
            };

            
            async function updateCompression() {
                if (!imageData.originalUrl) return;

                const quality = parseInt(qualitySlider.value) / 100;
                qualityValue.textContent = `${qualitySlider.value}%`;

                const img = new Image();
                img.src = imageData.originalUrl;
                
                await new Promise(resolve => {
                    img.onload = () => {
                        imageConversionCanvas.width = img.naturalWidth;
                        imageConversionCanvas.height = img.naturalHeight;
                        const ctx = imageConversionCanvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        imageData.compressedUrl = imageConversionCanvas.toDataURL('image/jpeg', quality);
                        compressedImageDisplay.innerHTML = `<img src="${imageData.compressedUrl}" alt="Compressed Preview">`;

                        const compressedSizeBytes = atob(imageData.compressedUrl.split(',')[1]).length;
                        const reduction = imageData.originalSize > 0 ? (1 - compressedSizeBytes / imageData.originalSize) * 100 : 0;
                        
                        fileSizeDisplay.innerHTML = `
                            Original: <strong>${formatFileSize(imageData.originalSize)}</strong> | 
                            Compressed: <strong>${formatFileSize(compressedSizeBytes)}</strong> 
                            <span class="text-green-600 font-bold">(${reduction.toFixed(1)}% smaller)</span>
                        `;
                        resolve();
                    };
                });
            }

            imageUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || !file.type.startsWith('image/')) {
                    showMessage('Please select a valid image file (JPG/PNG).', true);
                    return;
                }
                imageData.fileName = file.name.replace(/\.[^/.]+$/, "");
                imageData.originalSize = file.size;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageData.originalUrl = e.target.result;
                    originalImageDisplay.innerHTML = `<img src="${imageData.originalUrl}" alt="Original Preview">`;
                    
                    compressorProcessingArea.classList.remove('opacity-50', 'pointer-events-none');
                    downloadCompressedButton.disabled = false;
                    
                    showMessage(`Image "${file.name}" loaded!`);
                    updateCompression();
                };
                 reader.readAsDataURL(file);
            });
            
            qualitySlider.addEventListener('input', updateCompression);

            downloadCompressedButton.addEventListener('click', () => {
                if (!imageData.compressedUrl) {
                    showMessage('No compressed image to download.', true);
                    return;
                }
                const a = document.createElement('a');
                a.href = imageData.compressedUrl;
                a.download = `${imageData.fileName}-compressed.jpg`;
                a.click();
                showMessage('Compressed image downloaded!');
            });
        }

        // ===============================================
        // TOOL 3: ICON SCALER LOGIC
        // ===============================================
        {
            const DEFAULT_BASE_SIZE_SCALER = 32;
            const SCALES_SCALER = [2, 4, 8, 16];
            const svgInputScaler = document.getElementById('svgInputScaler');
            const convertButtonScaler = document.getElementById('convertButtonScaler');
            const resultsDivScaler = document.getElementById('resultsDivScaler');
            const resultsTitleScaler = document.getElementById('resultsTitleScaler');
            const messageBoxScaler = document.getElementById('messageBoxScaler');
            const svgFileUploaderScaler = document.getElementById('svgFileUploaderScaler');
            const uploadButtonScaler = document.getElementById('uploadButtonScaler');

            
            async function copyImageToClipboardScaler(dataUrl) {
                try {
                    const blob = await(await fetch(dataUrl)).blob();
                    await navigator.clipboard.write([new ClipboardItem({'image/png': blob})]);
                    showMessageScaler('Image copied successfully!');
                } catch (error) {
                    showMessageScaler('Copy failed. Please right-click to copy manually.', true);
                }
            }
            
            async function generateScaledImages() {
                const svgText = svgInputScaler.value.trim();
                resultsDivScaler.innerHTML = '';
                resultsTitleScaler.style.display = 'none';
                if (!svgText) { showMessageScaler('Please paste or upload SVG code.', true); return; }

                convertButtonScaler.disabled = true;
                convertButtonScaler.textContent = 'Generating...';

                try {
                    // Re-use the getSvgDimensions function from Tool 1's scope for base dimensions
                    const { width: baseWidth, height: baseHeight } = (function() {
                        const viewBoxMatch = svgText.match(/viewBox="[^"]*"/i);
                        if (viewBoxMatch) {
                            const parts = viewBoxMatch[0].slice(9, -1).split(/[,\s]+/);
                            if (parts.length === 4) return { width: Math.max(1, Math.round(parseFloat(parts[2]))), height: Math.max(1, Math.round(parseFloat(parts[3])))};
                        }
                        return { width: DEFAULT_BASE_SIZE_SCALER, height: DEFAULT_BASE_SIZE_SCALER };
                    })();
                    
                    const svgDataUrl = `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svgText)))}`;

                    for (const scale of SCALES_SCALER) {
                        const width = baseWidth * scale;
                        const height = baseHeight * scale;
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        
                        const img = new Image();
                        const dataUrl = await new Promise((resolve) => {
                            img.onload = () => { ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/png')); };
                            img.onerror = () => resolve(null);
                            img.src = svgDataUrl;
                        });
                        if(!dataUrl) continue;

                        const container = document.createElement('div');
                        container.className = 'flex flex-col items-center p-4 bg-[#f0f0f0] rounded-xl';
                        container.innerHTML = `
                            <img src="${dataUrl}" alt="${scale}x Scaled Image" class="scaled-image w-full h-auto bg-white p-2 rounded-lg mb-3">
                            <p class="text-sm font-semibold text-[#374151] mb-3">${scale}x (${width}x${height} px)</p>
                            <button class="copy-btn-scaler w-full px-4 py-2 bg-[#34A853] text-white font-semibold rounded-lg hover:bg-[#2c8d48] transition-colors duration-150 text-sm">Copy Image (PNG)</button>
                        `;
                        container.querySelector('.copy-btn-scaler').onclick = () => copyImageToClipboardScaler(dataUrl);
                        resultsDivScaler.appendChild(container);
                    }
                    resultsTitleScaler.style.display = 'block';
                } catch (error) {
                    showMessageScaler(`Error: ${error.message}`, true);
                } finally {
                    convertButtonScaler.disabled = false;
                    convertButtonScaler.textContent = 'Generate Scaled PNGs';
                }
            }

            convertButtonScaler.addEventListener('click', generateScaledImages);
            uploadButtonScaler.addEventListener('click', () => svgFileUploaderScaler.click());
            svgFileUploaderScaler.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => { svgInputScaler.value = e.target.result; generateScaledImages(); };
                    reader.readAsText(file);
                }
            });

            svgInputScaler.value = `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="#34A853" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
<path d="M16 3c-7.18 0-13 5.82-13 13s5.82 13 13 13 13-5.82 13-13-5.82-13-13-13z"/>
<path d="M12 20l8-8"/>
<path d="M20 20l-8-8"/>
</svg>`;
        }
        
        // ===============================================
        // INITIALIZATION
        // ===============================================
        loadToolState();
        
    </script>
</body>
</html>
